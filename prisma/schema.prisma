// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String   @id @default(cuid()) // Ganti ke String CUID
  name          String
  email         String   @unique
  emailVerified Boolean
  image         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  role          Role     @default(ADMIN_GUDANG)

  sessions Session[]
  accounts Account[]

  invoices     Invoice[]
  pos          PO[]
  barangMasuk  BarangMasuk[]
  barangKeluar BarangKeluar[]

  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime
  updatedAt DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
  @@index([userId])
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String? // Password disimpan di sini
  createdAt             DateTime
  updatedAt             DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  idToken String?

  @@map("account")
  @@index([userId])
}

model Verification {
  id         String    @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?

  @@map("verification")
  @@index([identifier])
}

enum Role {
  ADMIN_GUDANG
  ADMIN_DIST
  MANAJEMEN
}

model Barang {
  id         Int      @id @default(autoincrement())
  kodeBarang String   @unique
  namaBarang String
  stok       Int      @default(0)
  harga      Decimal  @db.Decimal(10, 2)
  satuan     String
  deskripsi  String?
  createdAt  DateTime @default(now())

  barangMasuk  BarangMasuk[]
  barangKeluar BarangKeluar[]
  invoiceItems InvoiceItem[]
  poItems      POItem[]
}

model BarangMasuk {
  id           Int      @id @default(autoincrement())
  tanggalMasuk DateTime
  jumlahMasuk  Int
  supplier     String // Nama Supplier
  nomorDokumen String? // Surat Jalan
  createdAt    DateTime @default(now())

  // Relasi
  barangId Int
  barang   Barang @relation(fields: [barangId], references: [id])
  userId   String // Admin Gudang yang input
  user     User   @relation(fields: [userId], references: [id])
}

model BarangKeluar {
  id            Int      @id @default(autoincrement())
  tanggalKeluar DateTime
  jumlahKeluar  Int
  tujuan        String // Tujuan pengiriman internal/eksternal
  nomorDokumen  String?
  createdAt     DateTime @default(now())

  // Relasi
  barangId Int
  barang   Barang @relation(fields: [barangId], references: [id])
  userId   String // Admin Gudang yang input
  user     User   @relation(fields: [userId], references: [id])
}

// Purchase Order 

model PO {
  id           Int      @id @default(autoincrement())
  nomorPO      String   @unique
  tanggal      DateTime
  supplierName String
  status       StatusPO @default(DRAFT)
  total        Decimal  @default(0) @db.Decimal(15, 2)
  createdAt    DateTime @default(now())

  // Relasi
  userId String // Admin Distributor yang buat
  user   User     @relation(fields: [userId], references: [id])
  items  POItem[]
}

// Detail Barang dalam PO

model POItem {
  id          Int     @id @default(autoincrement())
  qty         Int
  hargaSatuan Decimal @db.Decimal(10, 2)
  subtotal    Decimal @db.Decimal(15, 2)

  // Relasi
  poId     Int
  po       PO     @relation(fields: [poId], references: [id])
  barangId Int
  barang   Barang @relation(fields: [barangId], references: [id])
}

//Invoice untuk penjualan ke pelanggan/toko/mitra

model Invoice {
  id           Int           @id @default(autoincrement())
  nomorInvoice String        @unique
  tanggal      DateTime
  mitraName    String // Toko Tujuan
  total        Decimal       @default(0) @db.Decimal(15, 2)
  status       StatusInvoice @default(DRAFT)
  createdAt    DateTime      @default(now())

  // Relasi
  userId     String // Admin Distributor yang buat
  user       User          @relation(fields: [userId], references: [id])
  items      InvoiceItem[]
  pengiriman Pengiriman? // 1 Invoice punya 1 Pengiriman
}

// Detail Barang dalam Invoice

model InvoiceItem {
  id          Int     @id @default(autoincrement())
  qty         Int
  hargaSatuan Decimal @db.Decimal(10, 2)
  subtotal    Decimal @db.Decimal(15, 2)

  // Relasi
  invoiceId Int
  invoice   Invoice @relation(fields: [invoiceId], references: [id])
  barangId  Int
  barang    Barang  @relation(fields: [barangId], references: [id])
}

enum StatusPO {
  DRAFT
  ORDERED
  RECEIVED
  CANCELLED
}

enum StatusInvoice {
  DRAFT
  ISSUED
  PAID
  CANCELLED
}

// Pengiriman untuk mengelola status pengiriman barang keluar

model Pengiriman {
  id            Int              @id @default(autoincrement())
  nomorResi     String?
  tujuan        String
  kurir         String?
  tanggalKirim  DateTime?
  tanggalTerima DateTime?
  status        StatusPengiriman @default(DIPROSES)
  createdAt     DateTime         @default(now())

  // Relasi
  invoiceId Int     @unique
  invoice   Invoice @relation(fields: [invoiceId], references: [id])
}

enum StatusPengiriman {
  DIPROSES
  DIKIRIM
  SELESAI
  DIBATALKAN
}
